@startuml
autonumber

participant "渠道" as channel
participant "H5页面" as H5
participant "用户组" as userServer

alt#Gold #LightBlue "渠道参数转换"
channel->H5 : 访问接口xxx，\n渠道自己携带的参数：channelCode，权益/用户类型，xxx
activate channel #Yellow
activate H5 #black
H5->userServer: 下传渠道参数
activate userServer #FFBBBB

participant "开放平台" as openApi
userServer->openApi: 将渠道参数下传到开放平台(数据是否要加密)
activate openApi
openApi->openApi: 1.生成流水号\n2.根据渠道权益类型、channelcode获取配置信息\n3.使用productCode的值替换channelCode的值
openApi->userServer: 将cahnnelCode，跳转地址、流水号等字段返给用户组
deactivate openApi

userServer->H5:返给前端跳转链接、流水号等参数
deactivate userServer
end

participant "问诊" as inquiry
alt#Pink #LightGreen "问诊MQ通知"
H5->H5: H5 前端根据链接跳转相应的页面
H5->userServer : C端开始问诊, 下传流水号等信息
activate userServer #FFBBBB
userServer->inquiry: 参数继续下传给问诊
activate inquiry #LightBlue
inquiry-->userServer
deactivate inquiry
userServer-->H5
deactivate H5
deactivate userServer


H5->userServer: 问诊结束
activate userServer #FFBBBB
activate H5 #black
deactivate H5
userServer->inquiry: 问诊结束MQ通知开放平台，携带流水号、问诊单id
deactivate userServer
activate inquiry #LightBlue
inquiry->openApi:问诊发MQ通知开放平台,携带流水号, 问诊单id
deactivate inquiry
activate openApi
openApi->channel: 1.根据流水号查询渠道参数信息\n2.拼接渠道参数，调用渠道接口，回传问诊id
deactivate openApi
end

participant "订单中心" as orderCenter
alt#Gold #LightBlue "下单"
H5->userServer: 下单：(这里传参是否可以包含药品清单), 携带流水号
activate H5 #black
activate userServer #FFBBBB
userServer->orderCenter: 获取商品金额
activate orderCenter #Red
userServer->openApi: 调用查询抵扣金额,，携带流水号
activate openApi
orderCenter->userServer: 回传商品金额
deactivate orderCenter
openApi->channel: 1.根据订单号查询配置信息\n2.拼接渠道请求参数, 调用渠道接口回传处方id
openApi->userServer: 回传抵扣金额
userServer->H5
deactivate H5
deactivate userServer
deactivate openApi
end

alt#Pink #LightGreen "订单状态通知"
H5->userServer: 支付完成, 流水号下传
activate userServer #FFBBBB
activate H5 #black
userServer->orderCenter: 流水号下传
activate orderCenter #Red
orderCenter->userServer
orderCenter->openApi: MQ发送订单状态, 参数包括：流水号(外部订单号),订单号
deactivate orderCenter
activate openApi
openApi->channel: 1.根据订单号查询配置信息，调用渠道同步订单状态
deactivate channel
deactivate openApi
userServer->H5
deactivate userServer
deactivate H5
end
@enduml